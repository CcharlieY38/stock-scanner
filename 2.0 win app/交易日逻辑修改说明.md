# 交易日逻辑修改说明

## 修改日期
2025年10月14日

## 修改目的
将推荐股票的逻辑从使用"前7个自然日"改为"前7个交易日"，以更准确地反映A股市场的实际交易情况。

## 主要修改内容

### 1. 新增交易日获取方法
在 `EnhancedStockAnalyzer` 类中添加了 `_get_trading_dates()` 方法：
- 功能：获取指定日期范围内的A股交易日列表
- 逻辑：自动排除周末（周六、周日）
- 说明：实际使用中，K线数据本身已是交易日，此方法主要用于验证和说明

### 2. 增强 `_check_7day_rule()` 方法
修改了7日规则检查逻辑：
- **关键改进**：明确使用最近7个**交易日**而不是自然日
- **数据验证**：
  - 确保索引为日期类型
  - 对数据按日期排序
  - 验证交易日数量是否足够（至少7个）
- **诊断信息**：新增交易日期范围和交易日数量的记录
- **代码示例**：
  ```python
  # 确保索引为日期类型，并排序
  if not isinstance(df.index, pd.DatetimeIndex):
      df.index = pd.to_datetime(df.index)
  
  # 排序并取最近7个交易日（K线数据本身就是交易日，无需额外过滤）
  df_sorted = df.sort_index(ascending=True)
  w = df_sorted.tail(7).copy()
  ```

### 3. 更新 `_fetch_recent_ohlcv_light()` 方法文档
- 明确参数 `window_days` 指的是**交易日数量**而非自然日
- 添加注释说明返回的数据为交易日数据，已自动排除周末和节假日
- 添加调试日志，记录获取的交易日数量

### 4. 更新方法文档注释
更新了以下方法的文档说明：
- `_check_7day_rule()`: 强调使用7个交易日
- `_fetch_recent_ohlcv_light()`: 说明返回交易日数据
- `get_rule_based_recommendations()`: 明确使用交易日规则

## 关键技术点

### K线数据天然是交易日
- **重要原理**：从akshare或baostock获取的日K线数据本身就是交易日数据
- **自动过滤**：数据源已经排除了周末和节假日
- **无需额外处理**：只需要确保数据按时间排序，然后取最近N条即可

### 交易日识别逻辑
```python
# 方案1：简单规则（周一到周五）
if date.weekday() < 5:  # 0=周一, 4=周五
    # 是工作日（但不一定是交易日，可能是节假日）
    
# 方案2：使用K线数据本身（推荐）
# K线数据已经是交易日，直接使用即可
df = get_stock_data(stock_code)  # 返回的每一行就是一个交易日
trading_days = df.tail(7)  # 最近7个交易日
```

## 测试建议

### 1. 验证交易日数量
```python
analyzer = EnhancedStockAnalyzer()
df = analyzer._fetch_recent_ohlcv_light('000001', window_days=25)
print(f"获取到 {len(df)} 个交易日的数据")
```

### 2. 检查7日规则
```python
ok, score, diag = analyzer._check_7day_rule(df)
print(f"交易日期范围: {diag.get('trading_date_range')}")
print(f"交易日数量: {diag.get('trading_days_count')}")
print(f"规则满足: {ok}, 得分: {score}")
```

### 3. 完整推荐测试
```python
recommendations = analyzer.get_rule_based_recommendations(
    top_n=10,
    min_mktcap_e=30.0,
    exclude_st=True
)
print(f"推荐数量: {len(recommendations)}")
for rec in recommendations[:5]:
    print(f"{rec['stock_code']} {rec['stock_name']}: {rec['score']:.2f}")
```

## 影响范围

### 直接影响的功能
1. **规则推荐功能** (`get_rule_based_recommendations`)
   - 7日规则筛选更准确
   - 自动排除非交易日的干扰

2. **7日规则检查** (`_check_7day_rule`)
   - 确保分析的是连续的7个交易日
   - 提供更准确的技术分析信号

### 不受影响的功能
1. 快速推荐 (`get_quick_recommendations`) - 基于快照，不涉及7日规则
2. 深度分析 (`analyze_stock`) - 使用更长周期的技术分析
3. 基本面分析 - 不依赖短期交易日

## 优势总结

1. **更准确的分析**：使用实际交易日，避免周末和节假日的数据空白
2. **符合市场规律**：A股交易日才有价格和成交量变化
3. **代码健壮性**：增加了数据验证和错误处理
4. **可追溯性**：添加诊断信息，便于调试和验证
5. **性能优化**：利用K线数据天然是交易日的特性，无需额外过滤

## 注意事项

1. **节假日处理**：当前简单规则只排除周末，A股特殊节假日仍需要K线数据源来自动过滤
2. **数据源依赖**：依赖akshare或baostock提供准确的交易日K线数据
3. **回测注意**：使用历史数据回测时，确保数据源的交易日历准确性

## 未来改进方向

1. 可以集成更完整的A股交易日历（包括调休、节假日）
2. 可以添加交易日验证功能，检测数据源是否准确
3. 可以提供交易日统计信息（如：本月交易日数量、距离下一个休市日等）
