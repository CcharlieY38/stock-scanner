# 问题修复说明

## 修复的问题

### 1. CSS Transform 警告
**问题**: Qt 不支持 CSS `transform` 属性
**修复**: 移除了所有 `transform: translateY()` 样式

### 2. A股快照获取失败
**问题**: 网络不稳定导致 akshare API 调用失败
**修复**: 
- 添加了重试机制（最多3次）
- 添加了本地缓存回退
- 改进了错误日志
- 优化了超时处理

### 3. macOS 系统警告
**问题**: macOS 特有的 IMK 和 TSM 警告
**修复**:
- 添加了 `QT_LOGGING_RULES` 环境变量
- 添加了 `QT_MAC_DISABLE_FOREGROUND_APPLICATION_TRANSFORM`
- 优化了日志级别设置

## 新增功能

### 1. GUI 配置模块 (`gui_config.py`)
统一管理所有GUI相关的配置：
- 环境变量设置
- 日志配置
- 依赖检查
- 应用配置

### 2. 改进的启动脚本 (`start.py`)
提供更好的启动体验：
- 版本检查
- 依赖检查
- 错误处理
- 用户友好的提示

### 3. 快照获取优化
新增 `_get_stock_snapshot_with_retry()` 方法：
- 自动重试机制
- 递增等待时间
- 详细的日志记录
- 缓存回退

## 交易日逻辑改进

### 修改点
在 `stock_analyzer.py` 中：

1. **`_check_7day_rule()` 方法**
   - 现在使用最近7个交易日而不是自然日
   - 添加了交易日验证

2. **`_fetch_recent_ohlcv_light()` 方法**
   - 明确说明获取的是交易日数据
   - 添加了日志记录

3. **`get_rule_based_recommendations()` 方法**
   - 文档更新，明确说明使用交易日
   - 添加了相关日志

## 使用方法

### 方式1: 使用启动脚本（推荐）
```bash
python start.py
```

### 方式2: 直接启动GUI
```bash
python gui2.py
```

### 方式3: 使用虚拟环境
```bash
/Users/charlieyang/.venv/bin/python start.py
```

## 日志文件

程序运行时会生成以下日志文件：
- `stock_analyzer_gui.log` - GUI 日志
- `stock_analyzer.log` - 分析器日志

可以查看这些文件来诊断问题。

## 环境变量

程序会自动设置以下环境变量（macOS）：
```bash
QT_MAC_WANTS_LAYER=1
QT_ENABLE_HIGHDPI_SCALING=1
QT_AUTO_SCREEN_SCALE_FACTOR=1
QT_LOGGING_RULES=*.debug=false;qt.qpa.*=false
QT_MAC_DISABLE_FOREGROUND_APPLICATION_TRANSFORM=1
```

## 故障排除

### 如果仍然看到警告
1. 检查 Python 版本 >= 3.8
2. 更新 PyQt6: `pip install --upgrade PyQt6`
3. 清除缓存: 删除 `.cache` 目录
4. 查看日志文件定位问题

### 如果快照获取失败
1. 检查网络连接
2. 等待片刻后重试
3. 使用缓存数据（自动回退）
4. 检查防火墙设置

### 如果依赖缺失
```bash
pip install PyQt6 pandas numpy akshare baostock markdown2 jieba
```

## 性能优化

1. **快照缓存**: 本地缓存有效期4小时
2. **重试机制**: 渐进式退避（1s, 2s, 3s）
3. **日志级别**: 生产环境使用 INFO 级别

## 下一步计划

1. [ ] 添加更多的网络超时处理
2. [ ] 实现分布式缓存
3. [ ] 添加性能监控
4. [ ] 支持更多的数据源

## 版本信息

- 版本: 3.0.0
- 更新日期: 2025-10-14
- 主要改进: 交易日逻辑、错误处理、日志优化
